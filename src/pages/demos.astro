---
import fs from "fs";
import DefaultTemplate from "../components/DefaultTemplate/DefaultTemplate.astro";

type MediaItem = {
  name: string;
  url: string;
  type: "audio" | "video";
};

const mediaDir = new URL("../../public/media/", import.meta.url);

let mediaItems: MediaItem[] = [];

try {
  const rawBase = import.meta.env.BASE_URL || "/";
  const base = rawBase.endsWith("/") ? rawBase : `${rawBase}/`;

  mediaItems = fs
    .readdirSync(mediaDir)
    .filter((file) => /\.(mp3|mp4)$/i.test(file))
    .map((file) => ({
      name: file,
      url: `${base}media/${file}`,
      type: file.toLowerCase().endsWith(".mp4") ? "video" : "audio",
    }));
} catch (error) {
  mediaItems = [];
}
---

<DefaultTemplate title="Demos" metaDescription="Listen back to your audio and video takes.">
  <section class="page-header">
    <div class="stack">
      <p class="label">Demos</p>
      <h1>Drop clips, press play</h1>
      <p>Add .mp3 or .mp4 files into <code>public/media</code>. They will show up here automatically.</p>
    </div>
    <div class="card stack instructions">
      <strong>How to add files</strong>
      <ol>
        <li>Place your clips in <code>public/media</code>.</li>
        <li>Use short file names so they display cleanly.</li>
        <li>Refresh the page to see new items.</li>
      </ol>
    </div>
  </section>

  <section class="stack">
    <div class="media-grid">
      {
        mediaItems.length === 0 ? (
          <div class="empty">
            No clips yet. Drop an .mp3 or .mp4 into <code>public/media</code> to start.
          </div>
        ) : (
          mediaItems.map((item) => (
            <article class="media-card">
              <div class="media-meta">
                <span>{item.name}</span>
                <span>{item.type === "video" ? "MP4" : "MP3"}</span>
              </div>
              {item.type === "audio" ? (
                <audio controls preload="metadata" src={item.url} />
              ) : (
                <video controls preload="metadata">
                  <source src={item.url} type="video/mp4" />
                  Your browser does not support the video tag.
                </video>
              )}
            </article>
          ))
        )
      }
    </div>
  </section>
</DefaultTemplate>

<style>
  .label {
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    font-size: 0.85rem;
  }

  code {
    background: var(--color-panel);
    padding: 0.15rem 0.35rem;
    border-radius: 4px;
    border: 1px solid var(--color-border);
  }

  ol {
    margin: 0;
    padding-left: 1.25rem;
    color: var(--color-muted);
    display: grid;
    gap: var(--space-2xs);
  }

  .instructions strong {
    font-size: 1rem;
  }

  audio,
  video {
    width: 100%;
    border-radius: var(--radius-sm);
    border: 1px solid var(--color-border);
    background: #000;
  }
</style>
